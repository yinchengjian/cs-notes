# 传输层

## TCP与UDP的区别

TCP是面向连接的，可靠传输，具有流量控制，拥塞控制，面向字节流全双工通信的端到端的

UDP是无连接的，尽最大能力交付的，支持一对一，一对多，多对多

## UDP首部格式

首部8个字节，源端口，目标端口，长度，校验和

## TCP首部格式

序号seq：用来确认当前数据的序号位置

确认号ACK：告诉对方下一个想要的序号

同步号SYN：用于建立连接的标志位

终止号FIN：用于断开连接的标志位

窗口：用来表示通信双方某一方的接收能力

## TCP三次握手

- 开始状态B处于监听状态，等待客户端的连接请求
- A向B发送连接报文请求，SYN=1，ACK=0，seq=x
- B收到连接报文之后，同意连接，向A发送一个确认报文，SYN=1，ACK=1，ack=x+1，seq=y
- A在收到B的确认报文之后，还要向B发送确认报文，ack=y+1，seq=x+1

**三次握手的原因**

第三次握手是为了避免错误的连接请求，使得服务器错误打开连接。

当前客户端很久之前发送的连接请求报文，因为网络阻塞，过了很久才到达服务器端，其实这个时候服务器和客户端已经建立了连接，如果是二次握手，就还会再建立一次连接。

## TCP四次挥手

- 开始状态AB处于连接状态
- A向B发送连接断开报文，FIN=1
- B收到之后，进入close-wait状态，会给A回复一条确认报文，此时A无法向B通信，B可以向A通信
- 之后在B发送玩其他的报文之后，会再向A发送一条连接断开报文FIN=1
- A收到之后，发送确认报文，进入time-wait状态，等待2MSL之后释放连接
- B收到确认报文立即释放连接

close-wait的原因

这个状态就是为了让服务端把之前未发完的报文发送完毕

四次挥手的原因

- 确认最后一个确认报文B真实接收到了，如果B没有收到确认报文的话，还是会给A发送连接释放报文，2MSL足够收到B的报文
- 目的是让本次连接的所有报文全部消失，是的下次再连接的时候，不会出现上次连接的请求报文

## TCP的可靠传输

依靠的是超时重传，当通信另一端在超时时间之外还没有收到该报文，就会发送确认重传报文，来请求数据

## TCP的流量控制

是为了保证接收方来得及接收报文，是通过滑动窗口实现的，接收方可以设置窗口大小，用于通知发送方

## TCP的拥塞控制

是为了防止网络出现拥塞，有4个阶段：

慢开始，拥塞避免，快重传，快恢复

这里会有一个拥塞窗口用来表示当前的拥塞状况

慢开始阶段：

发送方的发送窗口一直翻倍，知道超过拥塞窗口/2

拥塞避免：

该阶段发送窗口每阶段+1，知道超过拥塞窗口，会继续进入慢开始阶段

快重传：

当在拥塞避免阶段，连续收到3个确认重传报文，证明没有发生拥塞，只是某一个报文丢失了，但接下来极可能会发生拥塞，所以进入快重传阶段，该阶段是发送窗口变为拥塞窗口的一半，在执行拥塞避免



